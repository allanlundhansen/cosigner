# cosigner-bitcoin

### Ownership & License

## Overview

A bitcoin implementation for cosigner-api  

## Current State

Unstable
  - Configuration is hard-coded, needs to be moved to a file-based solution
  - Wallet interface does not handle errors as gracefully as it could

## Testing recommendations

You'll need a bitcoin network, suggest using regtest for this. Also suggest using bitcoin-qt for network admin outside of cosigner, unless you enjoy copy/pasting lots of long base58/hex strings.

Edit/create your bitcoin.conf and add the following lines:
```bash
rpcuser=bitcoinrpc
rpcpassword=changeit
```

bitcoind:
```bash
  bitcoind -regtest -daemon
```

or bitcoin-qt:
```bash
  bitcoin-qt -regtest -server
```

Generate some coins if you haven't already:

(*only use 101 if you have never run regtest before, otherwise use 1, each run will give you 50 BTC*)
```bash
bitcoind-cli -regtest generate 101
```

Once that's working, run the JAR directly and it will provide you with command line access to the interface. 
```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getNewAddress <random hex string without leading 0x>
```

If using bitcoin-qt this is a little easier, send some BTC to the new address you generated. Run generate 10 to generate 10 confirmations.

Check the account balance (before and after your transaction above)
```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getBalance <address>
```

Create a transaction before and after the confirmations, and with too much/enough BTC. Will return "null" on failure, and a raw transaction on success. 

### Multi-sig test
Reset your regtest environment by deleting the regtest folder. Start up your local node in regtest mode.

Look in bitcoin-qt and grab the default wallet address it created. You only need the public key, important part is that bitcoin-qt knows about the private key for this one. It will not be aware of any private keys generated by cosigner, you can export the wallet to verify this.

Get two new addresses and copy them off somewhere.
```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getNewAddress <random hex string without leading 0x>
```
```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getNewAddress <same random hex string without leading 0x>
```

Create two multisig accounts with the cosigner addresses + wallet address.
```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getMultiSigAddress <cosigner address #1> <wallet address> <same hex string from earlier>
```

```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getMultiSigAddress <cosigner address #2> <wallet address> <same hex string from earlier>
```

(*Hex string explained: This is the user key, this is simulating a transfer from one user account to another. You can change it, but you need to remember which one was used with each address.*)

In bitcoin-qt, send some BTC to the first multiSig address. Run generate 10 times to confirm it.

Back to the command line, create a transaction transferring a portion of that BTC from one multiSig to the other. Suggest you don't split it 50/50, so that the balances are easier to reconcile.  

```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar createTransaction <multiSig address #1> <multiSig address #1> 10
```

Copy the output raw transaction. Now it's time to sign the transaction with the cosigner address. (*Bitcoind has no idea what the private key is, you need to provide the user key for the address so that we can sign it, if you don't it will try to sign it with whatever private key it has that matches*)

```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar signTransaction <transaction string> <cosigner address #1> <same hex string from earlier>
```

Copy the output again. Currently it's only set to 1-of-n so you can now send the transaction.

```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar sendTransaction <transaction string>
```

Run generate 10 again to confirm it, and check balances with

```bash
java -jar cosigner-bitcoin-0.0.1-SNAPSHOT.jar getBalance <address>
```

### Notes
It's currently hard-coded to access the server with http://bitcoinrpc:changeit@127.0.0.1:18332/, this will be configurable in the future.

Things that need fixing: 
- Change addresses on transaction.
- Address recovery logic
